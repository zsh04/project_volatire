syntax = "proto3";

package brain;

// The Brain Service (The Mind)
// Responsible for Reasoning, Forecasting, and Context.
service BrainService {
    // Pulse: Reflex sends a heartbeat to prove Consciousness is awake.
    rpc Heartbeat (Pulse) returns (PulseAck);

    // Event: Reflex notifies Brain of a Market Regime Change.
    rpc NotifyRegimeChange (RegimeEvent) returns (Empty);

    // Decision: Reflex asks Brain for a strategy decision based on state.
    rpc Reason (StateVector) returns (StrategyIntent);

    // Prediction: Reflex asks Brain to forecast future price/volatility.
    rpc Forecast (HistoryWindow) returns (ForecastResult);

    // Context: Reflex asks Brain for Semantic Context (Memory + Sentiment).
    rpc GetContext (ContextRequest) returns (ContextResponse);

    // Memory: Reflex saves a significant event (Trade/Veto) to Episodic Memory.
    rpc AddMemoryCheckpoint (MemoryCheckpoint) returns (Ack);
}

message ContextRequest {
    double price = 1;
    double velocity = 2; // For finding similar kinematic regimes
    int64 timestamp = 3;
    // D-87 Firewall: Hard Telemetry Injection
    string truth_envelope = 4; 
    string legislative_bias = 5; // D-107
    string active_adapter = 6; // D-95
}

message ContextResponse {
    double sentiment_score = 1; // -1.0 to 1.0 (D-38)
    string nearest_regime = 2; // "Liquidity Crisis 2020" (D-37)
    double regime_distance = 3; // Vector distance
    int64 computation_time_ns = 4;
    // D-87: Firewall Fields (Optional)
    string reasoning = 5; 
    double referenced_price = 6;
}

message Empty {}

message Pulse {
    int64 timestamp = 1;
    string organ = 2; // "REFLEX"
}

message PulseAck {
    bool alive = 1;
    int64 timestamp = 2;
}

message RegimeEvent {
    string regime = 1; // "HIGH_VOL", "TRENDING", "RANGING"
    double volatility = 2;
    double liquidity = 3;
}

message MacroState {
  double risk_free_rate = 1;  // DGS10 or FEDFUNDS
  double inflation_rate = 2;  // PCE or CPI
  double stress_index = 3;    // STLFSI4
  double sentiment_score = 4; // News Sentiment (-1.0 to 1.0)
  double hurdle_rate = 5;     // The Calculated MAR
}

message StateVector {
    double price = 1;
    double velocity = 2;
    double vol_cluster = 3;
    double entropy = 4;
    double simons_prediction = 5;
    string legislative_bias = 6; // D-107: "LONG_ONLY", "SHORT_ONLY", "NEUTRAL"
}

message StrategyIntent {
    string action = 1; // "BUY", "SELL", "HOLD"
    double confidence = 2;
    string model_used = 3;
    // Taleb Extensions
    double forecast_p10 = 4;
    double forecast_p50 = 5;
    double forecast_p90 = 6;
    int64 forecast_timestamp = 7; // Unix Milliseconds
    double forecast_p20 = 8;
    double forecast_p80 = 9;
    // Macro Gravity
    double hurdle_rate = 10;
    MacroState macro_context = 11;
}

message HistoryWindow {
    repeated double prices = 1;
    repeated double volumes = 2;
    int32 window_size = 3;
}

message ForecastResult {
    double p10 = 1;
    double p50 = 2;
    double p90 = 3;
    double horizon = 4;
}

message MemoryCheckpoint {
    int64 timestamp = 1;
    string type = 2; // "EPISODIC", "PROCEDURAL"
    string payload = 3; // JSON string of state/reasoning
    string outcome = 4; // "PROFIT", "LOSS", "VETO"
    string venue = 5; // "KRAKEN", "BINANCE"
    string vector_text = 6; // Text to vectorize (Reasoning or Market Narrative)
}

message Ack {
    bool success = 1;
    string message = 2;
}

