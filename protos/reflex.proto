syntax = "proto3";
package reflex;

service ReflexService {
  // --- Control Plane ---
  // 1. Get Physics State (Internal Mechanics)
  rpc GetPhysics (Empty) returns (PhysicsResponse);

  // 2. Get OODA State (Decision Logic)
  rpc GetOODA (Empty) returns (OODAResponse);

  // 3. Trigger Veto (Nuclear Option)
  rpc TriggerVeto (VetoRequest) returns (Ack);

  // 4. Demote Provisional (Safety Staircase)
  rpc DemoteProvisional (DemoteRequest) returns (Ack);

  // D-106: Forensic Time Machine
  rpc GetTickHistory (TickHistoryRequest) returns (stream PhysicsResponse);

  // D-83: Initiate Ignition
  rpc InitiateIgnition (Empty) returns (Ack);

  // D-107: Turn Key (Update Legislation)
  rpc UpdateLegislation (LegislativeUpdate) returns (Ack);

  // --- Legacy / Aux ---
  // Force a risk level change
  rpc TriggerRatchet (RatchetRequest) returns (Ack);
  // Update system config
  rpc UpdateConfig (ConfigPayload) returns (Ack);
  // Stream Physics Data (Live Telemetry)
  rpc GetStream (Empty) returns (stream PhysicsResponse);
}

// --- Messages ---

message TickHistoryRequest {
    string symbol = 1;
    double start_time = 2; // Unix ms
    double end_time = 3;   // Unix ms
}

message PhysicsResponse {
    double price = 1;
    double velocity = 2;
    double acceleration = 3;
    double jerk = 4;
    double entropy = 5;
    double efficiency_index = 6;
    double timestamp = 7;
    
    // Global Sequence ID (Directive-79)
    int64 sequence_id = 16;
    
    // Account State
    double unrealized_pnl = 8;
    double equity = 9;
    double balance = 10;
    double realized_pnl = 23;
    double btc_position = 24;
    
    // Model Telemetry
    double gemma_tokens_per_sec = 11;
    double gemma_latency_ms = 12; // 12
    
    // Governance (Safety Staircase)
    int32 staircase_tier = 13; // 0=Q0, 1=Q1 ...
    double staircase_progress = 14; 
    
    // Audit Telemetry
    double audit_drift = 15;
    
    // Directive-80: Vitality Sentinel metrics
    double system_latency_us = 17;
    double system_jitter_us = 18;
    string vitality_status = 19; // "OPTIMAL", "DEGRADED", "CRITICAL"
    
    // Directive-81: Reasoning Trace (Cognitive Projection)
    repeated ReasoningStep reasoning_trace = 20;

    // D-83: Ignition Status
    string ignition_status = 21; 
    
    // D-90: Recursive Risk Re-balancer Fidelity
    double system_sanity_score = 22;
    
    // Directive-105: The Fiscal Control Deck
    repeated PositionState positions = 25;
    repeated OrderState orders = 26;
}

message PositionState {
    string symbol = 1;
    double net_size = 2;
    double avg_entry_price = 3;
    double unrealized_pnl = 4; // Calculated live
    int64 entry_timestamp = 5; // Unix ms
    double current_price = 6;
}

message OrderState {
    string order_id = 1;
    string symbol = 2;
    string side = 3; // BUY/SELL
    double quantity = 4;
    double limit_price = 5;
    string status = 6; // OPEN, FILLED, CANCELLED
    int64 timestamp = 7;
}

message ReasoningStep {
    string id = 1;
    string content = 2;
    double probability = 3;
    string type = 4; // "hypothesis", "deduction", "conclusion"
    double timestamp = 5;
}

message OODAResponse {
    PhysicsResponse physics = 1;
    optional double sentiment_score = 2;
    optional string nearest_regime = 3;
    string decision = 4; // BUY, SELL, HOLD
    map<string, double> weights = 5; // Simons, Kepler, Hypatia weights
}

message VetoRequest {
    string reason = 1;
    string operator = 2;
}

message DemoteRequest {
    string reason = 1;
    string target_level = 2; // e.g., "Q1", "Floor"
}

message RatchetRequest {
  enum Level {
    IDLE = 0;
    TIGHTEN = 1; // Reduce size
    FREEZE = 2;  // Cancel all, hold cash
    KILL = 3;    // Liquidate everything, shutdown
  }
  Level level = 1;
  string reason = 2;
}

message LegislativeUpdate {
  // Strategic Bias (The Director)
  string bias = 1; // "NEUTRAL", "LONG_ONLY", "SHORT_ONLY"
  
  // Risk Scaling
  double aggression = 2; // 0.0 - 2.0 (Fidelity Multiplier)
  
  // Tactical Overrides
  bool maker_only = 3;
  bool hibernation = 4; // READ_ONLY mode
  
  // Command
  bool snap_to_breakeven = 5;
}

message ConfigPayload {
  string key = 1;
  double value = 2;
}

message Heartbeat {
  double timestamp = 1;
  bool brain_connected = 2;
  double efficiency_index = 3;
  double p_riemann = 4;
}

message Ack {
  bool success = 1;
  string message = 2;
}

message Empty {}